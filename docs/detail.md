


## èŠ‚ç‚¹é€šä¿¡


| ç±»å‹                    | ç›®çš„                      | å‘èµ·è€…               | æ¥æ”¶è€…         |
|-------------------------|---------------------------|----------------------|----------------|
| RequestVote RPC         | é€‰ä¸¾æ—¶è¯·æ±‚æŠ•ç¥¨            | å€™é€‰äººï¼ˆCandidateï¼‰   | å…¶ä»–æ‰€æœ‰èŠ‚ç‚¹    |
| AppendEntries RPC       | å¤åˆ¶æ—¥å¿— / å¿ƒè·³ä¿æŒ       | Leader               | å…¶ä»–æ‰€æœ‰èŠ‚ç‚¹    |
| InstallSnapshot RPCï¼ˆå¯é€‰ï¼‰ | å‘é€å¿«ç…§ï¼ˆæ—¥å¿—è¿‡é•¿æ—¶ï¼‰     | Leader               | è½åèŠ‚ç‚¹        |
| å®¢æˆ·ç«¯è¯·æ±‚è½¬å‘           | Clientè¯·æ±‚é”®å€¼æ“ä½œæ—¶       | Follower â†’ Leader    | Leader         |
| é›†ç¾¤é…ç½®å˜æ›´ï¼ˆMembership Changeï¼‰ | èŠ‚ç‚¹åŠ å…¥/ç¦»å¼€æ—¶           | Leader               | æ‰€æœ‰èŠ‚ç‚¹        |



```
raft/
â”œâ”€â”€ raft_node.h / raft_node.cpp        # Raft èŠ‚ç‚¹é€»è¾‘ï¼ˆé€‰ä¸¾ã€æ—¥å¿—å¤åˆ¶ã€çŠ¶æ€è½¬æ¢ï¼‰
â”œâ”€â”€ log_entry.h / log_entry.cpp        # Raft æ—¥å¿—æ¡ç›®ï¼ˆå°è£… command + term + indexï¼‰
â”œâ”€â”€ raft_log.h / raft_log.cpp          # æ—¥å¿—å­˜å‚¨ä¸æŒä¹…åŒ–ç®¡ç†ï¼ˆè¿½åŠ ã€æˆªæ–­ã€å¿«ç…§ï¼‰
â”œâ”€â”€ state_machine.h / state_machine.cpp# çŠ¶æ€æœºæ¥å£ï¼ˆä¸Šå±‚ KV åº”ç”¨å®ç°ï¼‰
â”œâ”€â”€ timer.h / timer.cpp                # é€‰ä¸¾/å¿ƒè·³è¶…æ—¶å®šæ—¶å™¨ï¼ˆç²¾å‡†æ§åˆ¶é€‰ä¸»ï¼‰
â”œâ”€â”€ raft_rpc.h / raft_rpc.cpp          # Raft ä¹‹é—´çš„ RPC é€šä¿¡å°è£…ï¼ˆRequestVote / AppendEntriesï¼‰
â”œâ”€â”€ raft_config.h / raft_config.cpp    # é…ç½®ç®¡ç†ï¼ˆé›†ç¾¤èŠ‚ç‚¹ã€ç«¯å£ã€IDåˆ†é…ï¼‰
â””â”€â”€ persistent_storage.h / cpp         # æŒä¹…åŒ–ç»„ä»¶ï¼ˆä¿å­˜termã€voteã€æ—¥å¿—ç­‰ï¼‰

```

| æ¨¡å— / æ–‡ä»¶ | æ˜¯å¦è®ºæ–‡ä¸­æåˆ° | åŠŸèƒ½è¯´æ˜ | å¯¹åº”è®ºæ–‡ç« èŠ‚ |
|-------------|----------------|----------|----------------|
| `raft_node.h / cpp` | âœ…  | Raft æ ¸å¿ƒçŠ¶æ€æœºï¼ˆé¢†å¯¼é€‰ä¸¾ã€æ—¥å¿—å¤åˆ¶ã€çŠ¶æ€è½¬æ¢ï¼‰ | 5.2 Leader Electionã€5.3 Log Replication |
| `log_entry.h / cpp` | âœ… | æ—¥å¿—æ¡ç›®ï¼ˆåŒ…å« `term`ã€`index`ã€commandï¼‰ | 5.3 Log Replication |
| `raft_log.h / cpp` | âœ… | æ—¥å¿—è¿½åŠ ã€æˆªæ–­ã€æäº¤ç­‰ | 5.4 Log Commitment |
| `state_machine.h / cpp` | âœ… | åº”ç”¨çŠ¶æ€æœºï¼ˆæ¯”å¦‚ KV å­˜å‚¨ï¼‰ | 7.1 Applying Logs |
| `timer.h / cpp` | âœ… | å®ç°é€‰ä¸¾è¶…æ—¶ã€å¿ƒè·³æ—¶é—´é—´éš” | 9. Practical Considerations |
| `raft_rpc.h / cpp` | âœ… | æ¨¡æ‹Ÿè®ºæ–‡ä¸­ RequestVote / AppendEntries çš„ RPC è¡Œä¸º | 5.2ã€5.3 |
| `raft_config.h / cpp` | âœ… | æ¯ä¸ªèŠ‚ç‚¹ IDã€é›†ç¾¤é…ç½® | 9.2 Membership Changes |
| `persistent_storage.h / cpp` | âœ… | termã€votedForã€æ—¥å¿—çš„æŒä¹…åŒ– | 7. Persistence |

### Raft è®ºæ–‡æ˜ç¡®è§„å®šå¿…é¡»â€œæŒä¹…åŒ–â€çš„ä¸‰æ ·ä¸œè¥¿ï¼š
åœ¨è®ºæ–‡ 7.1 ä¸­åˆ—å‡ºï¼Œå´©æºƒæ¢å¤æ—¶å¿…é¡»ä¿å­˜åœ¨ç£ç›˜ä¸Šï¼š

- å½“å‰ä»»æœŸ (currentTerm)
- å·²æŠ•ç»™è° (votedFor)
- æ—¥å¿—æ¡ç›® (log[])

ğŸ‘‰ è¿™äº›éƒ½è¢«æ”¾åœ¨ persistent_storage.cpp é‡Œï¼Œç¬¦åˆè§„èŒƒã€‚

```
raft/
â”œâ”€â”€ core/              # Raft æ ¸å¿ƒçŠ¶æ€æœºå’Œæ—¥å¿—
â”‚   â”œâ”€â”€ raft_node.h / cpp         # èŠ‚ç‚¹çŠ¶æ€æœºï¼ˆé€‰ä¸¾ã€å¤åˆ¶ã€çŠ¶æ€è½¬æ¢ï¼‰
â”‚   â”œâ”€â”€ raft_log.h / cpp          # æ—¥å¿—è¿½åŠ /å›é€€/æäº¤
â”‚   â”œâ”€â”€ log_entry.h / cpp         # å•æ¡æ—¥å¿—å®šä¹‰
â”‚   â””â”€â”€ state_machine.h / cpp     # åº”ç”¨çŠ¶æ€æœºï¼ˆå¦‚ KV å­˜å‚¨ï¼‰
â”‚
â”œâ”€â”€ rpc/               # Raft èŠ‚ç‚¹ä¹‹é—´é€šä¿¡
â”‚   â”œâ”€â”€ raft_rpc.h / cpp          # RPC æ¥å£å®ç°ï¼ˆè°ƒç”¨å°è£…ï¼‰
â”‚   â”œâ”€â”€ raft_rpc_server.h / cpp   # gRPC æœåŠ¡ç«¯
â”‚   â”œâ”€â”€ raft_rpc_client.h / cpp   # gRPC å®¢æˆ·ç«¯
â”‚   â””â”€â”€ raft.proto                # Protobuf æ¶ˆæ¯å®šä¹‰
â”‚
â”œâ”€â”€ timer/             # å®šæ—¶å™¨ï¼ˆé€‰ä¸¾ã€å¿ƒè·³ï¼‰
â”‚   â”œâ”€â”€ timer.h / cpp              # é€šç”¨å®šæ—¶å™¨å®ç°
â”‚   â””â”€â”€ election_timer.h / cpp    # ä¸“ç”¨äºé€‰ä¸¾çš„ Timer
â”‚
â”œâ”€â”€ storage/           # æŒä¹…åŒ–å’Œå¿«ç…§
â”‚   â”œâ”€â”€ persistent_storage.h / cpp  # ä¿å­˜ termã€voteã€æ—¥å¿—
â”‚   â””â”€â”€ snapshot.h / cpp            # å¿«ç…§å‹ç¼©æœºåˆ¶ï¼ˆé€‰åšï¼‰
â”‚
â””â”€â”€ config/            # é…ç½®å’ŒèŠ‚ç‚¹ä¿¡æ¯ç®¡ç†
    â”œâ”€â”€ raft_config.h / cpp         # èŠ‚ç‚¹IDã€ç«¯å£ã€é›†ç¾¤ä¿¡æ¯
    â””â”€â”€ cluster_info.h / cpp        # å½“å‰é›†ç¾¤çŠ¶æ€ï¼ˆæˆå‘˜ã€è§’è‰²ï¼‰
```

## Raft çš„ init å‡½æ•°ï¼š
å¯åŠ¨ Raft åè®®ä¸­çš„ 3 ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œåˆ†åˆ«æ˜¯ï¼š

- é¢†å¯¼è€…å‘é€å¿ƒè·³ï¼ˆleaderHearBeatTickerï¼‰

- å€™é€‰è€…å‘èµ·é€‰ä¸¾ï¼ˆelectionTimeOutTickerï¼‰

- æ—¥å¿—åº”ç”¨åˆ°çŠ¶æ€æœºï¼ˆapplierTickerï¼‰

å®ç°æ–¹å¼ï¼š
1ã€çº¿ç¨‹ï¼›2ã€å®šæ—¶å™¨ï¼›3ã€åç¨‹ï¼›4ã€å…¶ä»–äº‹ä»¶å¾ªç¯åº“